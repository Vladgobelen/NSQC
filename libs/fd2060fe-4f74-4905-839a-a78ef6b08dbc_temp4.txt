<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #36393f;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            min-width: 280px;
        }
        .app {
            display: flex;
            height: 100vh;
            min-width: 0;
        }
        .sidebar {
            width: 240px;
            min-width: 200px;
            background: #2f3136;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid #202225;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-width: 0;
        }
        .sidebar-title {
            font-weight: bold;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .settings-btn {
            background: none;
            border: none;
            color: #b9bbbe;
            cursor: pointer;
            font-size: 16px;
            flex-shrink: 0;
        }
        .settings-btn:hover {
            color: #ffffff;
        }
        .rooms-list {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
            min-width: 0;
        }
        .room-item {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            color: #b9bbbe;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .room-item:hover {
            background: #34373c;
            color: #ffffff;
        }
        .room-item.active {
            background: #5865f2;
            color: #ffffff;
            font-weight: 500;
        }
        .mic-control {
            padding: 16px;
            border-top: 1px solid #202225;
            min-width: 0;
        }
        .mic-button {
            width: 100%;
            padding: 10px;
            background: #5865f2;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-width: 0;
            font-size: 14px;
        }
        .mic-button:hover {
            background: #4752c4;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.25);
        }
        .mic-button:active {
            transform: translateY(0);
        }
        .mic-button.active {
            background: #ed4245;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            max-width: 100%;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #36393f;
            min-width: 0;
        }
        .chat-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #40444b;
            border-bottom: 1px solid #202225;
            min-width: 0;
        }
        .chat-header-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
        }
        .chat-header-controls {
            display: flex;
            align-items: center;
        }
        .toggle-sidebar-btn, .toggle-members-btn, .mobile-mic-btn {
            background: none;
            border: none;
            color: #b9bbbe;
            cursor: pointer;
            font-size: 18px;
            padding: 6px;
            margin: 0 2px;
        }
        .toggle-sidebar-btn:hover, .toggle-members-btn:hover, .mobile-mic-btn:hover {
            color: #ffffff;
        }
        .messages {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .message {
            display: flex;
            margin-bottom: 12px;
            animation: fadeIn 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
            min-width: 0;
        }
        .message.appeared {
            opacity: 1;
            transform: translateY(0);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-avatar {
            width: 36px;
            height: 36px;
            background: #5865f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        .message-content {
            flex: 1;
            background: #2f3136;
            border-radius: 8px;
            padding: 10px 14px;
            max-width: 85%;
            min-width: 0;
        }
        .message-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
            min-width: 0;
        }
        .message-username {
            font-weight: 500;
            margin-right: 8px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-time {
            font-size: 12px;
            color: #a3a6aa;
            flex-shrink: 0;
        }
        .message-text {
            color: #dcddde;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .input-area {
            padding: 12px;
            background: #40444b;
            margin: 0 12px 12px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 0;
        }
        .input-box {
            width: 100%;
            background: #36393f;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            color: #ffffff;
            font-size: 14px;
            outline: none;
            transition: all 0.2s ease;
            min-width: 0;
        }
        .input-box:focus {
            outline: 1px solid #00b0f4;
            box-shadow: 0 0 0 2px rgba(0, 176, 244, 0.2);
        }
        .input-box::placeholder {
            color: #72767d;
        }
        .members-panel {
            width: 220px;
            min-width: 180px;
            background: #2f3136;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }
        .members-header {
            padding: 12px 16px;
            font-size: 12px;
            font-weight: bold;
            color: #8e9297;
            text-transform: uppercase;
            border-bottom: 1px solid #202225;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-width: 0;
        }
        .members-list {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
            min-width: 0;
        }
        .member-item {
            padding: 8px;
            display: flex;
            align-items: center;
            color: #ffffff;
            font-size: 14px;
            border-radius: 4px;
            margin-bottom: 2px;
            transition: all 0.2s ease;
            min-width: 0;
        }
        .member-item:hover {
            background: #34373c;
        }
        .member-avatar {
            width: 32px;
            height: 32px;
            background: #5865f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .member-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .member-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #3ba55d;
            margin-left: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 0 6px rgba(59, 165, 93, 0.5);
            flex-shrink: 0;
        }
        .member-status.muted {
            background: #72767d;
            box-shadow: none;
        }
        .member-status.active {
            background: #3ba55d;
        }
        .status-bar {
            padding: 8px 12px;
            background: #202225;
            font-size: 12px;
            color: #b9bbbe;
            border-top: 1px solid #2f3136;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #3ba55d;
            margin-right: 8px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .status-indicator.connecting {
            background: #faa61a;
            animation: pulse 1.5s infinite;
        }
        .status-indicator.disconnected {
            background: #ed4245;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        /* === –î–û–ë–ê–í–õ–ï–ù–û: –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ === */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #2f3136;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #40444b;
            padding-bottom: 10px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #ffffff;
        }
        .setting-item {
            margin-bottom: 15px;
        }
        .setting-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #b9bbbe;
        }
        .setting-input {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #40444b;
            background: #36393f;
            color: #ffffff;
        }
        .setting-checkbox {
            margin-right: 8px;
        }
        .apply-settings-btn {
            width: 100%;
            padding: 10px;
            background: #5865f2;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-top: 10px;
        }
        .apply-settings-btn:hover {
            background: #4752c4;
        }
        /* === –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø === */
        @media (max-width: 900px) {
            .sidebar, .members-panel {
                position: absolute;
                top: 0;
                bottom: 0;
                z-index: 100;
                transform: translateX(-100%);
            }
            .sidebar {
                width: 260px;
            }
            .sidebar.visible {
                transform: translateX(0);
            }
            .members-panel {
                right: 0;
                transform: translateX(100%);
                width: 260px;
            }
            .members-panel.visible {
                transform: translateX(0);
            }
            .chat-header {
                display: flex;
            }
            .mic-control {
                display: none;
            }
        }
        @media (min-width: 901px) {
            .toggle-sidebar-btn, .toggle-members-btn, .mobile-mic-btn {
                display: none;
            }
            .chat-header {
                display: none;
            }
            .sidebar, .members-panel {
                position: relative;
                transform: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">üéô Voice Chat</div>
                <button class="settings-btn" id="openSettingsBtn">‚öô</button>
            </div>
            <div class="rooms-list">
                <div class="room-item active" data-room="general">üîä –û–±—â–∏–π –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª</div>
                <div class="room-item" data-room="music">üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞</div>
                <div class="room-item" data-room="conference">üíº –ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</div>
            </div>
            <div class="mic-control">
                <!-- –ö–Ω–æ–ø–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ) -->
                <button id="micButton" class="mic-button" disabled>
                    <span>üé§</span>
                    <span id="micButtonText">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</span>
                </button>
            </div>
        </div>
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-header-controls">
                    <button class="toggle-sidebar-btn" id="toggleSidebarBtn">‚ò∞</button>
                </div>
                <div class="chat-header-title" id="currentRoomTitle">–û–±—â–∏–π –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª</div>
                <div class="chat-header-controls">
                    <button class="mobile-mic-btn" id="mobileMicBtn">üé§</button>
                    <button class="toggle-members-btn" id="toggleMembersBtn">üë•</button>
                </div>
            </div>
            <div class="chat-area">
                <div class="messages" id="messagesContainer">
                    <div class="message appeared">
                        <div class="message-avatar">S</div>
                        <div class="message-content">
                            <div class="message-header">
                                <div class="message-username">System</div>
                                <div class="message-time" id="systemTime"></div>
                            </div>
                            <div class="message-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
                        </div>
                    </div>
                </div>
                <div class="input-area">
                    <input type="text" class="input-box" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." id="messageInput" disabled>
                </div>
            </div>
        </div>
        <div class="members-panel" id="membersPanel">
            <div class="members-header">
                –£—á–∞—Å—Ç–Ω–∏–∫–∏ ‚Äî <span id="membersCount">0</span>
                <button class="settings-btn" id="closeMembersPanelBtn">‚úï</button>
            </div>
            <div class="members-list" id="membersList">
                <div class="member-item">
                    <div class="member-avatar">–í—ã</div>
                    <div class="member-name">–í—ã</div>
                    <div class="member-status muted" id="selfStatus"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="status-bar">
        <span class="status-indicator" id="statusIndicator"></span>
        <span class="status-text" id="statusText">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ - –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>
    </div>
    
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞</div>
                <span class="close" id="closeSettingsModal">&times;</span>
            </div>
            <div class="setting-item">
                <label class="setting-label" for="bitrateSlider">–ë–∏—Ç—Ä–µ–π—Ç (–∫–±–∏—Ç/—Å): <span id="bitrateValue">32</span></label>
                <input type="range" min="16" max="64" value="32" class="setting-input" id="bitrateSlider">
            </div>
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" class="setting-checkbox" id="dtxCheckbox"> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DTX (—ç–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞)
                </label>
            </div>
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" class="setting-checkbox" id="fecCheckbox" checked> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FEC (—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –ø–æ—Ç–µ—Ä—è–º)
                </label>
            </div>
            <button class="apply-settings-btn" id="applySettingsBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∂–∞–µ–º mediasoup-client —á–µ—Ä–µ–∑ Nginx -->
    <script src="/mediasoup-client.min.js"></script>
    <script>
        class VoiceChatClient {
            constructor() {
                this.SERVER_URL = 'https://ns.fiber-gate.ru';
                this.device = null;
                this.clientID = this.generateClientID();
                this.sendTransport = null;
                this.recvTransport = null;
                this.audioProducer = null;
                this.consumers = new Map();
                this.stream = null;
                this.isMicActive = false;
                this.isConnected = false;
                this.currentRoom = 'general';
                this.keepAliveInterval = null;
                this.updateInterval = null;

                this.bitrate = 32000; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 32 –∫–±–∏—Ç/—Å
                this.dtxEnabled = true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é DTX –≤—ã–∫–ª—é—á–µ–Ω
                this.fecEnabled = true;  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é FEC –≤–∫–ª—é—á–µ–Ω

                window.voiceChatClient = this;

                this.micButton = document.getElementById('micButton');
                this.micButtonText = document.getElementById('micButtonText');
                this.statusText = document.getElementById('statusText');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.membersList = document.getElementById('membersList');
                this.membersCount = document.getElementById('membersCount');
                this.messagesContainer = document.getElementById('messagesContainer');
                this.messageInput = document.getElementById('messageInput');
                this.systemTime = document.getElementById('systemTime');
                this.selfStatus = document.getElementById('selfStatus');
                this.roomItems = document.querySelectorAll('.room-item');
                this.currentRoomTitle = document.getElementById('currentRoomTitle');
                this.mobileMicBtn = document.getElementById('mobileMicBtn');

                this.settingsModal = document.getElementById('settingsModal');
                this.openSettingsBtn = document.getElementById('openSettingsBtn');
                this.closeSettingsModal = document.getElementById('closeSettingsModal');
                this.bitrateSlider = document.getElementById('bitrateSlider');
                this.bitrateValue = document.getElementById('bitrateValue');
                this.dtxCheckbox = document.getElementById('dtxCheckbox');
                this.fecCheckbox = document.getElementById('fecCheckbox');
                this.applySettingsBtn = document.getElementById('applySettingsBtn');

                this.updateSystemTime();
                setInterval(() => this.updateSystemTime(), 60000);

                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                this.roomItems.forEach(item => {
                    item.addEventListener('click', () => {
                        this.roomItems.forEach(r => r.classList.remove('active'));
                        item.classList.add('active');
                        this.currentRoom = item.dataset.room;
                        const roomName = this.getRoomName(this.currentRoom);
                        this.currentRoomTitle.textContent = roomName;
                        this.addMessage('System', `–í—ã –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomName}`);
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                if (this.mobileMicBtn) {
                    this.mobileMicBtn.addEventListener('click', () => {
                        if (this.isConnected) {
                            this.toggleMicrophone();
                        } else if (!this.micButton.disabled) {
                            // –ï—Å–ª–∏ –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã, –Ω–æ –∫–Ω–æ–ø–∫–∞ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                            this.autoConnect();
                        }
                    });
                }

                // === –î–û–ë–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ===
                this.openSettingsBtn.addEventListener('click', () => this.openSettings());
                this.closeSettingsModal.addEventListener('click', () => this.settingsModal.style.display = 'none');
                this.bitrateSlider.addEventListener('input', () => {
                    this.bitrateValue.textContent = this.bitrateSlider.value;
                });
                this.applySettingsBtn.addEventListener('click', () => this.applySettings());
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                window.addEventListener('click', (event) => {
                    if (event.target === this.settingsModal) {
                        this.settingsModal.style.display = 'none';
                    }
                });
                // === –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ===

                // –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                this.autoConnect();
            }

            getRoomName(roomId) {
                const rooms = {
                    'general': '–û–±—â–∏–π –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª',
                    'music': '–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞',
                    'conference': '–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è'
                };
                return rooms[roomId] || roomId;
            }

            generateClientID() {
                return 'user_' + Math.random().toString(36).substr(2, 9);
            }

            updateStatus(message, type = 'normal') {
                this.statusText.textContent = message;
                this.statusIndicator.className = 'status-indicator';
                if (type === 'connecting') {
                    this.statusIndicator.classList.add('connecting');
                } else if (type === 'disconnected') {
                    this.statusIndicator.classList.add('disconnected');
                }
                console.log('[STATUS]', message);
            }

            updateSystemTime() {
                const now = new Date();
                this.systemTime.textContent = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }

            addMessage(username, text, time = null) {
                const now = new Date();
                const timeString = time || `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                const messageElement = document.createElement('div');
                messageElement.className = 'message new-message';
                const avatarText = username === '–í—ã' ? '–í—ã' : username.charAt(0).toUpperCase();
                messageElement.innerHTML = `
                    <div class="message-avatar">${avatarText}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <div class="message-username">${username}</div>
                            <div class="message-time">${timeString}</div>
                        </div>
                        <div class="message-text">${text}</div>
                    </div>
                `;
                this.messagesContainer.appendChild(messageElement);
                setTimeout(() => {
                    messageElement.classList.add('appeared');
                }, 10);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            sendMessage() {
                const message = this.messageInput.value.trim();
                if (message) {
                    this.addMessage('–í—ã', message);
                    this.messageInput.value = '';
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }
            }

            async autoConnect() {
                this.updateStatus('–ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'connecting');
                this.micButtonText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                try {
                    console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            echoCancellationType: 'system'
                        },
                        video: false
                    });
                    console.log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω', this.stream);
                    console.log('–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–∞...');
                    await this.registerClient();
                    this.startKeepAlive();
                    console.log('–ü–æ–ª—É—á–∞–µ–º RTP capabilities...');
                    const rtpCapabilities = await this.getRtpCapabilities();
                    console.log('RTP capabilities:', rtpCapabilities);
                    this.device = new mediasoupClient.Device();
                    await this.device.load({ routerRtpCapabilities: rtpCapabilities });
                    console.log('Device –∑–∞–≥—Ä—É–∂–µ–Ω');
                    await this.createTransports();
                    console.log('–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã —Å–æ–∑–¥–∞–Ω—ã');
                    this.isConnected = true;
                    this.updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'normal');
                    this.micButtonText.textContent = '–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                    this.micButton.disabled = false;
                    this.micButton.onclick = () => this.toggleMicrophone();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏
                    if (this.mobileMicBtn) {
                        this.mobileMicBtn.onclick = () => this.toggleMicrophone();
                    }
                    this.messageInput.disabled = false;
                    this.startParticipantUpdates();
                    this.addMessage('System', '–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ! –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω.');
                } catch (error) {
                    this.updateStatus('–û—à–∏–±–∫–∞: ' + error.message, 'disconnected');
                    this.micButtonText.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                    this.micButton.disabled = false;
                    console.error('[AUTO CONNECT ERROR]', error);
                }
            }

            async registerClient() {
                const response = await fetch(`${this.SERVER_URL}/api/client/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientID: this.clientID })
                });
                return response.json();
            }

            startKeepAlive() {
                this.keepAliveInterval = setInterval(async () => {
                    try {
                        await this.registerClient();
                    } catch (error) {
                        console.log('[KEEP-ALIVE ERROR]', error);
                    }
                }, 5000);
            }

            async getRtpCapabilities() {
                const response = await fetch(`${this.SERVER_URL}/api/rtp-capabilities`);
                return response.json();
            }

            async createTransports() {
                const sendTransportData = await this.createTransport('send');
                this.sendTransport = this.device.createSendTransport({
                    id: sendTransportData.transportId,
                    iceParameters: sendTransportData.iceParameters,
                    iceCandidates: sendTransportData.iceCandidates,
                    dtlsParameters: sendTransportData.dtlsParameters
                });
                this.setupSendTransport();
                const recvTransportData = await this.createTransport('recv');
                this.recvTransport = this.device.createRecvTransport({
                    id: recvTransportData.transportId,
                    iceParameters: recvTransportData.iceParameters,
                    iceCandidates: recvTransportData.iceCandidates,
                    dtlsParameters: recvTransportData.dtlsParameters
                });
                this.setupRecvTransport();
            }

            async createTransport(direction) {
                const response = await fetch(`${this.SERVER_URL}/api/transport/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Client-ID': this.clientID
                    },
                    body: JSON.stringify({
                        clientID: this.clientID,
                        direction: direction
                    })
                });
                return response.json();
            }

            setupSendTransport() {
                this.sendTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                    try {
                        await fetch(`${this.SERVER_URL}/api/transport/connect`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Client-ID': this.clientID
                            },
                            body: JSON.stringify({
                                transportId: this.sendTransport.id,
                                dtlsParameters
                            })
                        });
                        callback();
                    } catch (error) {
                        errback(error);
                    }
                });
                this.sendTransport.on('produce', async ({ kind, rtpParameters }, callback, errback) => {
                    try {
                        const response = await fetch(`${this.SERVER_URL}/api/produce`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Client-ID': this.clientID
                            },
                            body: JSON.stringify({
                                transportId: this.sendTransport.id,
                                kind,
                                rtpParameters
                            })
                        });
                        const data = await response.json();
                        callback({ id: data.producerId });
                    } catch (error) {
                        errback(error);
                    }
                });
            }

            setupRecvTransport() {
                this.recvTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                    try {
                        await fetch(`${this.SERVER_URL}/api/transport/connect`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Client-ID': this.clientID
                            },
                            body: JSON.stringify({
                                transportId: this.recvTransport.id,
                                dtlsParameters
                            })
                        });
                        callback();
                    } catch (error) {
                        errback(error);
                    }
                });
            }

            async toggleMicrophone() {
                if (this.isMicActive) {
                    await this.stopMicrophone();
                } else {
                    await this.startMicrophone();
                }
            }

            async startMicrophone() {
                try {
                    // –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —Ç—Ä–µ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω, –ø–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π
                    if (!this.stream || this.stream.getAudioTracks().length === 0 || this.stream.getAudioTracks()[0].readyState === 'ended') {
                        this.updateStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'connecting');
                        this.stream = await navigator.mediaDevices.getUserMedia({
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                autoGainControl: true,
                                echoCancellationType: 'system'
                            },
                            video: false
                        });
                    }
                    const audioTrack = this.stream.getAudioTracks()[0];

                    // === –ò–ó–ú–ï–ù–ï–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ produce ===
                    const encodings = [
                        {
                            maxBitrate: this.bitrate, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                            dtx: this.dtxEnabled,     // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                            fec: this.fecEnabled      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                        }
                    ];

                    this.audioProducer = await this.sendTransport.produce({
                        track: audioTrack,
                        encodings: encodings // <-- –ü–µ—Ä–µ–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                    });
                    // === –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ===

                    this.isMicActive = true;
                    this.micButton.classList.add('active');
                    this.micButtonText.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                    this.selfStatus.className = 'member-status active';
                    this.updateStatus('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω - –≤–∞—Å —Å–ª—ã—à–∞—Ç!', 'normal');
                    this.addMessage('System', `–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω - –≤–∞—Å —Å–ª—ã—à–∞—Ç! (–ë–∏—Ç—Ä–µ–π—Ç: ${this.bitrate/1000} –∫–±–∏—Ç/—Å, DTX: ${this.dtxEnabled ? '–≤–∫–ª' : '–≤—ã–∫–ª'}, FEC: ${this.fecEnabled ? '–≤–∫–ª' : '–≤—ã–∫–ª'})`);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏
                    if (this.mobileMicBtn) {
                        this.mobileMicBtn.textContent = 'üé§';
                        this.mobileMicBtn.style.color = '#ed4245'; // –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                    }
                } catch (error) {
                    this.updateStatus('–û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ' + error.message, 'disconnected');
                    console.error('[MIC ERROR]', error);
                }
            }

            async stopMicrophone() {
                if (this.audioProducer) {
                    try {
                        await fetch(`${this.SERVER_URL}/api/producer/close`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Client-ID': this.clientID
                            },
                            body: JSON.stringify({ producerId: this.audioProducer.id })
                        });
                        this.audioProducer.close();
                        this.audioProducer = null;
                    } catch (error) {
                        console.error('[MIC CLOSE ERROR]', error);
                    }
                }
                this.isMicActive = false;
                this.micButton.classList.remove('active');
                this.micButtonText.textContent = '–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                this.selfStatus.className = 'member-status muted';
                this.updateStatus('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω - –≤—ã —Ç–æ–ª—å–∫–æ —Å–ª—É—à–∞–µ—Ç–µ', 'normal');
                this.addMessage('System', '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω - –≤—ã —Ç–æ–ª—å–∫–æ —Å–ª—É—à–∞–µ—Ç–µ');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏
                if (this.mobileMicBtn) {
                    this.mobileMicBtn.textContent = 'üé§';
                    this.mobileMicBtn.style.color = '#b9bbbe'; // –°–µ—Ä—ã–π —Ü–≤–µ—Ç –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                }
            }

            async updateParticipants() {
                try {
                    const response = await fetch(`${this.SERVER_URL}/api/clients?clientID=${this.clientID}`);
                    const data = await response.json();
                    this.updateMembersList(data.clients);
                    const otherClients = data.clients.filter(clientId => clientId !== this.clientID);
                    for (const clientId of otherClients) {
                        await this.consumeClientProducers(clientId);
                    }
                } catch (error) {
                    console.error('[PARTICIPANTS ERROR]', error);
                }
            }

            updateMembersList(clients) {
                const otherClients = clients.filter(clientId => clientId !== this.clientID);
                this.membersCount.textContent = otherClients.length + 1;
                let membersHTML = `
                    <div class="member-item">
                        <div class="member-avatar">–í—ã</div>
                        <div class="member-name">–í—ã</div>
                        <div class="member-status ${this.isMicActive ? 'active' : 'muted'}" id="selfStatus"></div>
                    </div>
                `;
                otherClients.forEach(clientId => {
                    const shortId = clientId.substring(0, 6);
                    const firstChar = shortId.charAt(0).toUpperCase();
                    membersHTML += `
                        <div class="member-item">
                            <div class="member-avatar">${firstChar}</div>
                            <div class="member-name">${shortId}</div>
                            <div class="member-status"></div>
                        </div>
                    `;
                });
                this.membersList.innerHTML = membersHTML;
                this.selfStatus = document.getElementById('selfStatus');
            }

            async consumeClientProducers(clientId) {
                if (clientId === this.clientID) return;
                try {
                    const response = await fetch(`${this.SERVER_URL}/api/client/${clientId}/producers`);
                    const data = await response.json();
                    for (const producerId of data.producers) {
                        if (!this.consumers.has(producerId)) {
                            await this.consumeProducer(producerId, clientId);
                        }
                    }
                } catch (error) {
                    console.error('[CONSUME CLIENT ERROR]', error);
                }
            }

            async consumeProducer(producerId, clientId) {
                if (clientId === this.clientID) return;
                try {
                    const response = await fetch(`${this.SERVER_URL}/api/consume`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Client-ID': this.clientID
                        },
                        body: JSON.stringify({
                            producerId: producerId,
                            rtpCapabilities: this.device.rtpCapabilities,
                            transportId: this.recvTransport.id
                        })
                    });
                    const data = await response.json();
                    if (data.error) {
                        console.error('[CONSUME ERROR]', data.error);
                        return;
                    }
                    const consumer = await this.recvTransport.consume({
                        id: data.consumerId,
                        producerId: data.producerId,
                        kind: data.kind,
                        rtpParameters: data.rtpParameters
                    });
                    this.consumers.set(producerId, consumer);
                    this.playAudio(consumer.track, clientId, producerId);
                } catch (error) {
                    console.error('[CONSUME PRODUCER ERROR]', error);
                }
            }

            playAudio(track, clientId, producerId) {
                try {
                    const mediaStream = new MediaStream([track.clone()]);
                    const audioElement = document.createElement('audio');
                    audioElement.srcObject = mediaStream;
                    audioElement.volume = 0.8;
                    audioElement.style.display = 'none';
                    document.body.appendChild(audioElement);
                    setTimeout(() => {
                        const playPromise = audioElement.play();
                        if (playPromise !== undefined) {
                            playPromise
                                .then(() => console.log('[AUDIO] Playback started for:', clientId))
                                .catch(err => console.log('[AUDIO] Playback failed for:', clientId, err));
                        }
                    }, 100);
                    if (!window.audioElements) window.audioElements = new Map();
                    window.audioElements.set(producerId, audioElement);
                } catch (error) {
                    console.error('[AUDIO ERROR]', error);
                }
            }

            async startParticipantUpdates() {
                await this.updateParticipants();
                this.updateInterval = setInterval(async () => {
                    await this.updateParticipants();
                }, 3000);
            }

            // === –î–û–ë–ê–í–õ–ï–ù–û: –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ ===
            openSettings() {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                this.bitrateSlider.value = this.bitrate / 1000; // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –∫–±–∏—Ç/—Å –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞
                this.bitrateValue.textContent = this.bitrateSlider.value;
                this.dtxCheckbox.checked = this.dtxEnabled;
                this.fecCheckbox.checked = this.fecEnabled;
                this.settingsModal.style.display = 'block';
            }

            async applySettings() {
                const newBitrate = parseInt(this.bitrateSlider.value) * 1000; // –ü–µ—Ä–µ–≤–æ–¥–∏–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–∏—Ç/—Å
                const newDtx = this.dtxCheckbox.checked;
                const newFec = this.fecCheckbox.checked;

                const bitrateChanged = newBitrate !== this.bitrate;
                const dtxChanged = newDtx !== this.dtxEnabled;
                const fecChanged = newFec !== this.fecEnabled;

                if (bitrateChanged || dtxChanged || fecChanged) {
                    this.bitrate = newBitrate;
                    this.dtxEnabled = newDtx;
                    this.fecEnabled = newFec;

                    this.addMessage('System', `–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: –ë–∏—Ç—Ä–µ–π—Ç ${this.bitrate/1000} –∫–±–∏—Ç/—Å, DTX ${this.dtxEnabled ? '–≤–∫–ª' : '–≤—ã–∫–ª'}, FEC ${this.fecEnabled ? '–≤–∫–ª' : '–≤—ã–∫–ª'}`);

                    // –ï—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                    if (this.isMicActive) {
                         await this.updateProducerSettings();
                    }
                }

                this.settingsModal.style.display = 'none';
            }

            async updateProducerSettings() {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–∏–∫—Ä–æ—Ñ–æ–Ω
                await this.stopMicrophone();
                // –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω–æ–≤–æ —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                await this.startMicrophone();
                this.addMessage('System', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã. –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω.');
            }
            // === –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ===

            destroy() {
                if (this.keepAliveInterval) clearInterval(this.keepAliveInterval);
                if (this.updateInterval) clearInterval(this.updateInterval);
                if (this.audioProducer) this.audioProducer.close();
                this.consumers.forEach(consumer => consumer.close());
                if (this.sendTransport) this.sendTransport.close();
                if (this.recvTransport) this.recvTransport.close();
                if (this.stream) this.stream.getTracks().forEach(track => track.stop());
                if (window.audioElements) {
                    window.audioElements.forEach(element => {
                        if (element.parentNode) element.parentNode.removeChild(element);
                    });
                }
            }
        }
        // === –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ===

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof mediasoupClient === 'undefined') {
                document.getElementById('statusText').textContent = '–û—à–∏–±–∫–∞: mediasoup-client –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω';
                document.getElementById('statusIndicator').className = 'status-indicator disconnected';
                return;
            }
            new VoiceChatClient();
        });

        window.addEventListener('beforeunload', () => {
            if (window.voiceChatClient) {
                window.voiceChatClient.destroy();
            }
        });
    </script>
</body>
</html>
–≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫. –ò –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–∏–¥–∏–º–æ  —Ç–æ–∂–µ. –ù—É–∂–Ω–æ –ø–æ—á–∏–Ω–∏—Ç—å, –Ω–µ –Ω–∞—Ä—É—à–∏–≤ –æ—Å—Ç–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.
–ò—Å–ø—Ä–∞–≤—å –∏ –¥–∞–π –ø–æ–ª–Ω—ã–π –∫–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π